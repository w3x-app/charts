{{- if and (.Values.secret) (.Values.secret.enabled) }}

{{- $postgresAdminPassword := include "porsyar.postgresAdminPassword" . }}
{{- $postgresUserPassword := include "porsyar.postgresUserPassword" . }}
{{- $redisPassword := include "porsyar.redisPassword" . }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ template "porsyar.name" . }}-app-secrets
  labels:
    {{- include "porsyar.labels" . | nindent 4 }}
data:
  {{- if .Values.redis.enabled }}
  {{- if .Values.redis.auth.enabled }}
  REDIS_URL: {{ printf "redis://:%s@porsyar-redis-master:6379" $redisPassword | b64enc }}
  {{- else }}
  REDIS_URL: {{ "redis://porsyar-redis-master:6379" | b64enc }}
  {{- end }}
  {{- else }}
  REDIS_URL: {{ .Values.redis.externalRedisUrl | b64enc }}
  {{- end }}
  {{- if .Values.postgresql.enabled }}
  {{- /*
      Bitnami PostgreSQL (dependency) exposes the primary service as:
      - <fullnameOverride>-primary when architecture=replication
      - <fullnameOverride> (no suffix) when architecture=standalone
      We compute the correct host so the app does not point to a non-existent DNS entry.
    */}}
  {{- $pgFullname := default (printf "%s-postgresql" .Release.Name) .Values.postgresql.fullnameOverride }}
  {{- $pgArchitecture := default "standalone" .Values.postgresql.architecture }}
  {{- $pgHost := ternary (printf "%s-primary" $pgFullname) $pgFullname (eq $pgArchitecture "replication") }}
  {{- $pgUser := default "postgres" .Values.postgresql.auth.username }}
  {{- $pgDb := default "postgres" .Values.postgresql.auth.database }}
  DATABASE_URL: {{ printf "postgresql://%s:%s@%s/%s" $pgUser $postgresUserPassword $pgHost $pgDb | b64enc }}
  {{- else }}
  DATABASE_URL: {{ .Values.postgresql.externalDatabaseUrl | b64enc }}
  {{- end }}
  CRON_SECRET: {{ include "porsyar.cronSecret" . | b64enc }}	
  ENCRYPTION_KEY: {{ include "porsyar.encryptionKey" . | b64enc }}
  NEXTAUTH_SECRET: {{ include "porsyar.nextAuthSecret" . | b64enc }}
  {{- if and (.Values.enterprise.licenseKey) (ne .Values.enterprise.licenseKey "") }}
  ENTERPRISE_LICENSE_KEY: {{ .Values.enterprise.licenseKey | b64enc }}
  {{- end }}
  {{- if and .Values.redis.enabled .Values.redis.auth.enabled }}
  REDIS_PASSWORD: {{ $redisPassword | b64enc }}
  {{- end }}
  {{- if .Values.postgresql.enabled }}
  POSTGRES_ADMIN_PASSWORD: {{ $postgresAdminPassword | b64enc }}
  POSTGRES_USER_PASSWORD: {{ $postgresUserPassword | b64enc }}
  {{- end }}
{{- end }}
